# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build & Development

Requires `libhunspell-dev` installed (CGo dependency).

```bash
# Build
go build ./...

# Test
go test ./...

# Run a single test
go test ./internal -run TestExpandPattern

# Regenerate golden test files
REGENERATE=true go test ./...

# Lint (CI uses golangci-lint v2.7)
golangci-lint run --timeout=4m

# Database setup (requires Docker for local Postgres)
mage sql:postgres     # create local Postgres container
mage sql:db           # create database and role
mage sql:migrate      # run migrations

# Regenerate sqlc code after changing postgres/queries.sql or schema
mage sql:generate
```

## Architecture

Spellcheck microservice combining hunspell with a custom dictionary stored in PostgreSQL. Exposes two Twirp RPC services: `elephant.spell.Check` (spellcheck text, get suggestions) and `elephant.spell.Dictionaries` (manage custom entries).

### Key design decisions

- **Dual database pools**: A direct connection (`CONN_STRING`) for PostgreSQL `LISTEN/NOTIFY` and an optional PgBouncer connection (`BOUNCER_CONN_STRING`) for general queries. LISTEN/NOTIFY cannot go through PgBouncer.
- **Real-time updates**: Custom dictionary changes propagate via PostgreSQL `LISTEN/NOTIFY` on the `entry_update` channel, processed in `runListener()`.
- **Phrase matching**: Sliding window (up to 3 words) over text using tries for both valid phrases and common mistakes. Pattern expansion syntax `{A|B} {1|2}` generates all combinations.
- **Embedded dictionaries**: Bundled hunspell dictionaries (sv, en-gb, en-us, da, fi, nb, nn) via `//go:embed` in `dictionaries/`.
- **One `*Spellcheck` per language**: Each holds a hunspell instance, phrase trie, mistakes trie, and buffer pool.

### Code generation

- `postgres/` is generated by sqlc — do not hand-edit (except `entry.go` which has custom types).
- Protobuf/Twirp types come from `github.com/ttab/elephant-api/spell` (external module, not generated here).

## Go Style

- Never ignore errors. Use `elephantine.Close` for deferred closes and `elephantine/pg.Rollback` for deferred rollbacks.
- Error wrapping states the action attempted: `fmt.Errorf("load entries: %w", err)` — not `"failed to load entries"`.
- Auth scope for dictionary writes: `spell_write`.
- Commit messages: lowercase, imperative mood. Sometimes prefixed with ticket ID like `ELELOG-422`.
